
<!-- saved from url=(0127)file:///D:/My%20Documents/%E6%A1%8C%E9%9D%A2/Android_Port/Web/Android%E6%B7%BB%E5%8A%A0%E9%A9%B1%E5%8A%A8%E7%A4%BA%E4%BE%8B.htm -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></head><body contenteditable="true"><p style="text-indent:2em;">
	<!--[if gte mso 9]>微软中国微软中国412013-01-29T06:55:00Z2013-01-29T07:01:00Z1380021662www.xunchi.com180502541211.9999<![endif]--><!--[if gte mso 9]>falsefalsefalseMicrosoftInternetExplorer4<![endif]--><!--[if gte mso 9]><![endif]-->
<!--[if gte mso 10]>
<![endif]--><!--[if gte mso 9]><![endif]--><!--[if gte mso 9]><![endif]-->
</p>
<p style="text-indent:2em;">
	<br>
</p>
<div id="container">
	<div id="body">
		<div id="main">
			<div id="article_details">
				<div>
					<h3>
						<span class="linktitle"><span style="font-family:宋体;"><a href="file:///D:/My%20Documents/%E6%A1%8C%E9%9D%A2/Android_Port/Web/Android%E6%B7%BB%E5%8A%A0%E9%A9%B1%E5%8A%A8%E7%A4%BA%E4%BE%8B_files/Android%E6%B7%BB%E5%8A%A0%E9%A9%B1%E5%8A%A8%E7%A4%BA%E4%BE%8B.htm"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">在</span></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Ubuntu</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">上为</span></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">系统编写</span></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Linux</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">内核驱动程序</span></span><span><span> </span></span></a></span></span> 
					</h3>
				</div>
				<div id="article_content">
					<p>
						<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">在智能手机时代，每个品牌的手机都有自己的个性特点。正是依靠这种与众不同的个性来吸引用户，营造品牌凝聚力和用户忠城度，典型的代表非</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">iphone</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">莫属了。</span><span><a href="http://www.ifanr.com/39850"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">据统计</span></span></a></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">，截止</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">2011</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">年</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">5</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">月，</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">AppStore</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">的应用软件数量达</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">381062</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">个，位居第一，而</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android Market</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">的应用软件数量达</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">294738</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">，紧随</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">AppStore</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">后面，并有望在</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">8</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">月份越过</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">AppStore</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">。随着</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">系统逐步扩大市场占有率，终端设备的多样性亟需更多的移动开发人员的参与。</span><span><a href="http://tech.ifeng.com/internet/detail_2011_06/13/6971800_0.shtml"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">据业内统计</span></span></a></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">，</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">研发人才缺口至少</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">30</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">万。目前，对</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">人才需求一类是偏向硬件驱动的</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">人才需求，一类是偏向软件应用的</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">人才需求。总的来说，对有志于从事</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">硬件驱动的开发工程师来说，现在是一个大展拳脚的机会。那么，就让一起来看看如何为</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">系统编写内核驱动程序吧。</span>
					</p>
					<p>
						<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">这里，不会为真实的硬件设备编写内核驱动程序。为了方便描述为</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">系统编写内核驱动程序的过程，使用一个虚拟的硬件设备，这个设备只有一个</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">4</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">字节的寄存器，它可读可写。想起第一次学习程序语言时，都喜欢用“</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Hello, World</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">”作为例子，这里，就把这个虚拟的设备命名为“</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">”，而这个内核驱动程序也命名为</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">驱动程序。其实，</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">内核驱动程序和一般</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Linux</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">内核驱动程序的编写方法是一样的，都是以</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Linux</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">模块的形式实现的，具体可参考前面</span><span><a href="http://blog.csdn.net/luoshengyang/article/details/6557518"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">学习启动篇</span></span></a></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">一文中提到的</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Linux Device Drivers</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">一书。不过，这里还是从</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">系统的角度来描述</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">内核驱动程序的编写和编译过程。</span>
					</p>
					<p>
						<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; </span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">一</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">. </span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">参照前面两篇文章</span><span><a href="http://blog.csdn.net/luoshengyang/article/details/6559955"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">在Ubuntu</span></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">上下载、编译和安装Android</span></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">最新源代码</span></span></a></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">和</span><span><a href="http://blog.csdn.net/luoshengyang/article/details/6564592"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">在Ubuntu</span></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">上下载、编译和安装Android</span></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">最新内核源代码（Linux
Kernel</span></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">）</span></span></a></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">准备好</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">内核驱动程序开发环境。</span>
					</p>
					<p>
						<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; </span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">二</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">. </span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">进入到</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">kernel/common/drivers</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">目录，新建</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">目录：</span>
					</p>
					<p>
						<span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp;</span><strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">USER-NAME@MACHINE-NAME:~/Android$
cd kernel/common/drivers</span></strong></span> 
					</p>
					<p>
						<strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp;
&nbsp; &nbsp; USER-NAME@MACHINE-NAME:~/Android/kernel/common/drivers$ mkdir
hello</span></strong> 
					</p>
					<p>
						<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; </span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">三</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">. </span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">在</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">目录中增加</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello.h</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件：</span>
					</p>
					<div>
						<p class="MsoNormal" style="margin-left:18.0pt;">
							<br>
						</p>
					</div>
<pre><span>#ifndef _HELLO_ANDROID_H_</span></pre>
<pre><span>#define _HELLO_ANDROID_H_</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>#include &lt;linux/cdev.h&gt;</span></pre>
<pre><span>#include &lt;linux/semaphore.h&gt;</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>#define HELLO_DEVICE_NODE_NAME<span> </span>"hello"</span></pre>
<pre><span>#define HELLO_DEVICE_FILE_NAME<span> </span>"hello"</span></pre>
<pre><span>#define HELLO_DEVICE_PROC_NAME<span> </span>"hello"</span></pre>
<pre><span>#define HELLO_DEVICE_CLASS_NAME "hello"</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>struct hello_android_dev {</span></pre>
<pre><span><span> </span>int val;</span></pre>
<pre><span><span> </span>struct semaphore sem;</span></pre>
<pre><span><span> </span>struct cdev dev;</span></pre>
<pre><span>};</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>#endif</span></pre>
					<p>
						<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp;&nbsp;</span></span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">这个头文件定义了一些字符串常量宏，在后面要用到。此外，还定义了一个字符设备结构体</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">hello_android_dev</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">，这个就是虚拟的硬件设备了，</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">val</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">成员变量就代表设备里面的寄存器，它的类型为</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">int</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">，</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">sem</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">成员变量是一个信号量，是用同步访问寄存器</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">val</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">的，</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">dev</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">成员变量是一个内嵌的字符设备，这个</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">Linux</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">驱动程序自定义字符设备结构体的标准方法。</span><span></span> 
					</p>
					<p>
						<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; </span></span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">四</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">.</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">在</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">hello</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">目录中增加</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">hello.c</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">文件，这是驱动程序的实现部分。驱动程序的功能主要是向上层提供访问设备的寄存器的值，包括读和写。这里，提供了三种访问设备寄存器的方法，一是通过</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">proc</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">文件系统来访问，二是通过传统的设备文件的方法来访问，三是通过</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">devfs</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">文件系统来访问。下面分段描述该驱动程序的实现。</span><span></span> 
					</p>
					<p>
						<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; </span></span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">首先是包含必要的头文件和定义三种访问设备的方法：</span> 
					</p>
					<div>
						<p class="MsoNormal" style="margin-left:18.0pt;">
							<br>
						</p>
					</div>
<pre><span>#include &lt;linux/init.h&gt;</span></pre>
<pre><span>#include &lt;linux/module.h&gt;</span></pre>
<pre><span>#include &lt;linux/types.h&gt;</span></pre>
<pre><span>#include &lt;linux/fs.h&gt;</span></pre>
<pre><span>#include &lt;linux/proc_fs.h&gt;</span></pre>
<pre><span>#include &lt;linux/device.h&gt;</span></pre>
<pre><span>#include &lt;asm/uaccess.h&gt;</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>#include "hello.h"</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>/*</span><span>主设备和从设备号变量<span>*/</span></span></pre>
<pre><span>static int hello_major = 0;</span></pre>
<pre><span>static int hello_minor = 0;</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>/*</span><span>设备类别和设备变量<span>*/</span></span></pre>
<pre><span>static struct class* hello_class = NULL;</span></pre>
<pre><span>static struct hello_android_dev* hello_dev = NULL;</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>/*</span><span>传统的设备文件操作方法<span>*/</span></span></pre>
<pre><span>static int hello_open(struct inode* inode, struct file* filp);</span></pre>
<pre><span>static int hello_release(struct inode* inode, struct file* filp);</span></pre>
<pre><span>static ssize_t hello_read(struct file* filp, char __user *buf, size_t count, loff_t* f_pos);</span></pre>
<pre><span>static ssize_t hello_write(struct file* filp, const char __user *buf, size_t count, loff_t* f_pos);</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>/*</span><span>设备文件操作方法表<span>*/</span></span></pre>
<pre><span>static struct file_operations hello_fops = {</span></pre>
<pre><span><span> </span>.owner = THIS_MODULE,</span></pre>
<pre><span><span> </span>.open = hello_open,</span></pre>
<pre><span><span> </span>.release = hello_release,</span></pre>
<pre><span><span> </span>.read = hello_read,</span></pre>
<pre><span><span> </span>.write = hello_write,</span></pre>
<pre><span>};</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>/*</span><span>访问设置属性方法<span>*/</span></span></pre>
<pre><span>static ssize_t hello_val_show(struct device* dev, struct device_attribute* attr,<span> </span>char* buf);</span></pre>
<pre><span>static ssize_t hello_val_store(struct device* dev, struct device_attribute* attr, const char* buf, size_t count);</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>/*</span><span>定义设备属性<span>*/</span></span></pre>
<pre><span>static DEVICE_ATTR(val, S_IRUGO | S_IWUSR, hello_val_show, hello_val_store);</span></pre>
					<p>
						<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; </span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp; &nbsp;</span><span style="font-size:9.0pt;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">定义传统的设备文件访问方法，主要是定义</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello_open</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">、</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello_release</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">、</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello_read</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">和</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello_write</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">这四个打开、释放、读和写设备文件的方法：</span></span> 
					</p>
					<div>
						<div>
							<br>
						</div>
						<p class="MsoNormal" style="margin-left:18.0pt;">
							<span style="line-height:1.5;font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">/*</span><span style="line-height:1.5;font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">打开设备方法*/</span> 
						</p>
					</div>
<pre><span>static int hello_open(struct inode* inode, struct file* filp) {</span></pre>
<pre><span><span> </span>struct hello_android_dev* dev;<span> </span><span></span></span></pre>
<pre><span><span> </span></span></pre>
<pre><span><span> </span>/*</span><span>将自定义设备结构体保存在文件指针的私有数据域中，以便访问设备时拿来用<span>*/</span></span></pre>
<pre><span><span> </span>dev = container_of(inode-&gt;i_cdev, struct hello_android_dev, dev);</span></pre>
<pre><span><span> </span>filp-&gt;private_data = dev;</span></pre>
<pre><span><span> </span></span></pre>
<pre><span><span> </span>return 0;</span></pre>
<pre><span>}</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>/*</span><span>设备文件释放时调用，空实现<span>*/</span></span></pre>
<pre><span>static int hello_release(struct inode* inode, struct file* filp) {</span></pre>
<pre><span><span> </span>return 0;</span></pre>
<pre><span>}</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>/*</span><span>读取设备的寄存器<span>val</span>的值<span>*/</span></span></pre>
<pre><span>static ssize_t hello_read(struct file* filp, char __user *buf, size_t count, loff_t* f_pos) {</span></pre>
<pre><span><span> </span>ssize_t err = 0;</span></pre>
<pre><span><span> </span>struct hello_android_dev* dev = filp-&gt;private_data;<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>/*</span><span>同步访问<span>*/</span></span></pre>
<pre><span><span> </span>if(down_interruptible(&amp;(dev-&gt;sem))) {</span></pre>
<pre><span><span> </span>return -ERESTARTSYS;</span></pre>
<pre><span><span> </span>}</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>if(count &lt; sizeof(dev-&gt;val)) {</span></pre>
<pre><span><span> </span>goto out;</span></pre>
<pre><span><span> </span>}<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>/*</span><span>将寄存器<span>val</span>的值拷贝到用户提供的缓冲区<span>*/</span></span></pre>
<pre><span><span> </span>if(copy_to_user(buf, &amp;(dev-&gt;val), sizeof(dev-&gt;val))) {</span></pre>
<pre><span><span> </span>err = -EFAULT;</span></pre>
<pre><span><span> </span>goto out;</span></pre>
<pre><span><span> </span>}</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>err = sizeof(dev-&gt;val);</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>out:</span></pre>
<pre><span><span> </span>up(&amp;(dev-&gt;sem));</span></pre>
<pre><span><span> </span>return err;</span></pre>
<pre><span>}</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>/*</span><span>写设备的寄存器值<span>val*/</span></span></pre>
<pre><span>static ssize_t hello_write(struct file* filp, const char __user *buf, size_t count, loff_t* f_pos) {</span></pre>
<pre><span><span> </span>struct hello_android_dev* dev = filp-&gt;private_data;</span></pre>
<pre><span><span> </span>ssize_t err = 0;<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>/*</span><span>同步访问<span>*/</span></span></pre>
<pre><span><span> </span>if(down_interruptible(&amp;(dev-&gt;sem))) {</span></pre>
<pre><span><span> </span>return -ERESTARTSYS;<span> </span></span></pre>
<pre><span><span> </span>}<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>if(count != sizeof(dev-&gt;val)) {</span></pre>
<pre><span><span> </span>goto out;<span> </span></span></pre>
<pre><span><span> </span>}<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>/*</span><span>将用户提供的缓冲区的值写到设备寄存器去<span>*/</span></span></pre>
<pre><span><span> </span>if(copy_from_user(&amp;(dev-&gt;val), buf, count)) {</span></pre>
<pre><span><span> </span>err = -EFAULT;</span></pre>
<pre><span><span> </span>goto out;</span></pre>
<pre><span><span> </span>}</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>err = sizeof(dev-&gt;val);</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>out:</span></pre>
<pre><span><span> </span>up(&amp;(dev-&gt;sem));</span></pre>
<pre><span><span> </span>return err;</span></pre>
<pre><span>}</span></pre>
					<p>
						<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp; </span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;</span><span style="font-size:9.0pt;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">定义通过</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">devfs</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件系统访问方法，这里把设备的寄存器</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">val</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">看成是设备的一个属性，通过读写这个属性来对设备进行访问，主要是实现</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello_val_show</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">和</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello_val_store</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">两个方法，同时定义了两个内部使用的访问</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">val</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">值的方法</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">__hello_get_val</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">和</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">__hello_set_val</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">：</span></span> 
					</p>
					<div>
						<p class="MsoNormal" style="margin-left:18.0pt;">
							<br>
						</p>
					</div>
<pre><span>/*</span><span>读取寄存器<span>val</span>的值到缓冲区<span>buf</span>中，内部使用<span>*/</span></span></pre>
<pre><span>static ssize_t __hello_get_val(struct hello_android_dev* dev, char* buf) {</span></pre>
<pre><span><span> </span>int val = 0;<span> </span><span></span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>/*</span><span>同步访问<span>*/</span></span></pre>
<pre><span><span> </span>if(down_interruptible(&amp;(dev-&gt;sem))) {<span> </span></span></pre>
<pre><span><span> </span>return -ERESTARTSYS;<span> </span></span></pre>
<pre><span><span> </span>}<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>val = dev-&gt;val;<span> </span></span></pre>
<pre><span><span> </span>up(&amp;(dev-&gt;sem));<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>return snprintf(buf, PAGE_SIZE, "%d\n", val);</span></pre>
<pre><span>}</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>/*</span><span>把缓冲区<span>buf</span>的值写到设备寄存器<span>val</span>中去，内部使用<span>*/</span></span></pre>
<pre><span>static ssize_t __hello_set_val(struct hello_android_dev* dev, const char* buf, size_t count) {</span></pre>
<pre><span><span> </span>int val = 0;<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>/*</span><span>将字符串转换成数字<span>*/<span> </span></span></span></pre>
<pre><span><span> </span>val = simple_strtol(buf, NULL, 10);<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>/*</span><span>同步访问<span>*/<span> </span></span></span></pre>
<pre><span><span> </span>if(down_interruptible(&amp;(dev-&gt;sem))) {<span> </span></span></pre>
<pre><span><span> </span>return -ERESTARTSYS;<span> </span></span></pre>
<pre><span><span> </span>}<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>dev-&gt;val = val;<span> </span></span></pre>
<pre><span><span> </span>up(&amp;(dev-&gt;sem));</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>return count;</span></pre>
<pre><span>}</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>/*</span><span>读取设备属性<span>val*/</span></span></pre>
<pre><span>static ssize_t hello_val_show(struct device* dev, struct device_attribute* attr, char* buf) {</span></pre>
<pre><span><span> </span>struct hello_android_dev* hdev = (struct hello_android_dev*)dev_get_drvdata(dev);<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>return __hello_get_val(hdev, buf);</span></pre>
<pre><span>}</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>/*</span><span>写设备属性<span>val*/</span></span></pre>
<pre><span>static ssize_t hello_val_store(struct device* dev, struct device_attribute* attr, const char* buf, size_t count) {</span></pre>
<pre><span><span> </span>struct hello_android_dev* hdev = (struct hello_android_dev*)dev_get_drvdata(dev);<span> </span></span></pre>
<pre><span><span> </span></span></pre>
<pre><span><span> </span>return __hello_set_val(hdev, buf, count);</span></pre>
<pre><span>}</span></pre>
					<p>
						<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="font-size:9.0pt;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">定义通过</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">proc</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件系统访问方法，主要实现了</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello_proc_read</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">和</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello_proc_write</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">两个方法，同时定义了在</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">proc</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件系统创建和删除文件的方法</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello_create_proc</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">和</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello_remove_proc</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">：</span></span> 
					</p>
					<div>
						<p class="MsoNormal" style="margin-left:18.0pt;">
							<br>
						</p>
					</div>
<pre><span>/*</span><span>读取设备寄存器<span>val</span>的值，保存在<span>page</span>缓冲区中<span>*/</span></span></pre>
<pre><span>static ssize_t hello_proc_read(char* page, char** start, off_t off, int count, int* eof, void* data) {</span></pre>
<pre><span><span> </span>if(off &gt; 0) {</span></pre>
<pre><span><span> </span>*eof = 1;</span></pre>
<pre><span><span> </span>return 0;</span></pre>
<pre><span><span> </span>}</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>return __hello_get_val(hello_dev, page);</span></pre>
<pre><span>}</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>/*</span><span>把缓冲区的值<span>buff</span>保存到设备寄存器<span>val</span>中去<span>*/</span></span></pre>
<pre><span>static ssize_t hello_proc_write(struct file* filp, const char __user *buff, unsigned long len, void* data) {</span></pre>
<pre><span><span> </span>int err = 0;</span></pre>
<pre><span><span> </span>char* page = NULL;</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>if(len &gt; PAGE_SIZE) {</span></pre>
<pre><span><span> </span>printk(KERN_ALERT"The buff is too large: %lu.\n", len);</span></pre>
<pre><span><span> </span>return -EFAULT;</span></pre>
<pre><span><span> </span>}</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>page = (char*)__get_free_page(GFP_KERNEL);</span></pre>
<pre><span><span> </span>if(!page) {<span> </span></span></pre>
<pre><span><span> </span>printk(KERN_ALERT"Failed to alloc page.\n");</span></pre>
<pre><span><span> </span>return -ENOMEM;</span></pre>
<pre><span><span> </span>}<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>/*</span><span>先把用户提供的缓冲区值拷贝到内核缓冲区中去<span>*/</span></span></pre>
<pre><span><span> </span>if(copy_from_user(page, buff, len)) {</span></pre>
<pre><span><span> </span>printk(KERN_ALERT"Failed to copy buff from user.\n");<span> </span></span></pre>
<pre><span><span> </span>err = -EFAULT;</span></pre>
<pre><span><span> </span>goto out;</span></pre>
<pre><span><span> </span>}</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>err = __hello_set_val(hello_dev, page, len);</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>out:</span></pre>
<pre><span><span> </span>free_page((unsigned long)page);</span></pre>
<pre><span><span> </span>return err;</span></pre>
<pre><span>}</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>/*</span><span>创建<span>/proc/hello</span>文件<span>*/</span></span></pre>
<pre><span>static void hello_create_proc(void) {</span></pre>
<pre><span><span> </span>struct proc_dir_entry* entry;</span></pre>
<pre><span><span> </span></span></pre>
<pre><span><span> </span>entry = create_proc_entry(HELLO_DEVICE_PROC_NAME, 0, NULL);</span></pre>
<pre><span><span> </span>if(entry) {</span></pre>
<pre><span><span> </span>entry-&gt;owner = THIS_MODULE;</span></pre>
<pre><span><span> </span>entry-&gt;read_proc = hello_proc_read;</span></pre>
<pre><span><span> </span>entry-&gt;write_proc = hello_proc_write;</span></pre>
<pre><span><span> </span>}</span></pre>
<pre><span>}</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>/*</span><span>删除<span>/proc/hello</span>文件<span>*/</span></span></pre>
<pre><span>static void hello_remove_proc(void) {</span></pre>
<pre><span><span> </span>remove_proc_entry(HELLO_DEVICE_PROC_NAME, NULL);</span></pre>
<pre><span>}</span></pre>
					<p>
						<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; </span></span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">最后，定义模块加载和卸载方法，这里只要是执行设备注册和初始化操作：</span> 
					</p>
					<p></p>
<pre><span>/*</span><span>初始化设备<span>*/</span></span></pre>
<pre><span>static int<span> </span>__hello_setup_dev(struct hello_android_dev* dev) {</span></pre>
<pre><span><span> </span>int err;</span></pre>
<pre><span><span> </span>dev_t devno = MKDEV(hello_major, hello_minor);</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>memset(dev, 0, sizeof(struct hello_android_dev));</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>cdev_init(&amp;(dev-&gt;dev), &amp;hello_fops);</span></pre>
<pre><span><span> </span>dev-&gt;dev.owner = THIS_MODULE;</span></pre>
<pre><span><span> </span>dev-&gt;dev.ops = &amp;hello_fops;<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>/*</span><span>注册字符设备<span>*/</span></span></pre>
<pre><span><span> </span>err = cdev_add(&amp;(dev-&gt;dev),devno, 1);</span></pre>
<pre><span><span> </span>if(err) {</span></pre>
<pre><span><span> </span>return err;</span></pre>
<pre><span><span> </span>}<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>/*</span><span>初始化信号量和寄存器<span>val</span>的值<span>*/</span></span></pre>
<pre><span><span> </span>init_MUTEX(&amp;(dev-&gt;sem));</span></pre>
<pre><span><span> </span>dev-&gt;val = 0;</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>return 0;</span></pre>
<pre><span>}</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>/*</span><span>模块加载方法<span>*/</span></span></pre>
<pre><span>static int __init hello_init(void){</span></pre>
<pre><span><span> </span>int err = -1;</span></pre>
<pre><span><span> </span>dev_t dev = 0;</span></pre>
<pre><span><span> </span>struct device* temp = NULL;</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>printk(KERN_ALERT"Initializing hello device.\n");<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>/*</span><span>动态分配主设备和从设备号<span>*/</span></span></pre>
<pre><span><span> </span>err = alloc_chrdev_region(&amp;dev, 0, 1, HELLO_DEVICE_NODE_NAME);</span></pre>
<pre><span><span> </span>if(err &lt; 0) {</span></pre>
<pre><span><span> </span>printk(KERN_ALERT"Failed to alloc char dev region.\n");</span></pre>
<pre><span><span> </span>goto fail;</span></pre>
<pre><span><span> </span>}</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>hello_major = MAJOR(dev);</span></pre>
<pre><span><span> </span>hello_minor = MINOR(dev);<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>/*</span><span>分配<span>helo</span>设备结构体变量<span>*/</span></span></pre>
<pre><span><span> </span>hello_dev = kmalloc(sizeof(struct hello_android_dev), GFP_KERNEL);</span></pre>
<pre><span><span> </span>if(!hello_dev) {</span></pre>
<pre><span><span> </span>err = -ENOMEM;</span></pre>
<pre><span><span> </span>printk(KERN_ALERT"Failed to alloc hello_dev.\n");</span></pre>
<pre><span><span> </span>goto unregister;</span></pre>
<pre><span><span> </span>}<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>/*</span><span>初始化设备<span>*/</span></span></pre>
<pre><span><span> </span>err = __hello_setup_dev(hello_dev);</span></pre>
<pre><span><span> </span>if(err) {</span></pre>
<pre><span><span> </span>printk(KERN_ALERT"Failed to setup dev: %d.\n", err);</span></pre>
<pre><span><span> </span>goto cleanup;</span></pre>
<pre><span><span> </span>}<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>/*</span><span>在<span>/sys/class/</span>目录下创建设备类别目录<span>hello*/</span></span></pre>
<pre><span><span> </span>hello_class = class_create(THIS_MODULE, HELLO_DEVICE_CLASS_NAME);</span></pre>
<pre><span><span> </span>if(IS_ERR(hello_class)) {</span></pre>
<pre><span><span> </span>err = PTR_ERR(hello_class);</span></pre>
<pre><span><span> </span>printk(KERN_ALERT"Failed to create hello class.\n");</span></pre>
<pre><span><span> </span>goto destroy_cdev;</span></pre>
<pre><span><span> </span>}<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>/*</span><span>在<span>/dev/</span>目录和<span>/sys/class/hello</span>目录下分别创建设备文件<span>hello*/</span></span></pre>
<pre><span><span> </span>temp = device_create(hello_class, NULL, dev, "%s", HELLO_DEVICE_FILE_NAME);</span></pre>
<pre><span><span> </span>if(IS_ERR(temp)) {</span></pre>
<pre><span><span> </span>err = PTR_ERR(temp);</span></pre>
<pre><span><span> </span>printk(KERN_ALERT"Failed to create hello device.");</span></pre>
<pre><span><span> </span>goto destroy_class;</span></pre>
<pre><span><span> </span>}<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>/*</span><span>在<span>/sys/class/hello/hello</span>目录下创建属性文件<span>val*/</span></span></pre>
<pre><span><span> </span>err = device_create_file(temp, &amp;dev_attr_val);</span></pre>
<pre><span><span> </span>if(err &lt; 0) {</span></pre>
<pre><span><span> </span>printk(KERN_ALERT"Failed to create attribute val.");<span> </span></span></pre>
<pre><span><span> </span>goto destroy_device;</span></pre>
<pre><span><span> </span>}</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>dev_set_drvdata(temp, hello_dev);<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>/*</span><span>创建<span>/proc/hello</span>文件<span>*/</span></span></pre>
<pre><span><span> </span>hello_create_proc();</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>printk(KERN_ALERT"Succedded to initialize hello device.\n");</span></pre>
<pre><span><span> </span>return 0;</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>destroy_device:</span></pre>
<pre><span><span> </span>device_destroy(hello_class, dev);</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>destroy_class:</span></pre>
<pre><span><span> </span>class_destroy(hello_class);</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>destroy_cdev:</span></pre>
<pre><span><span> </span>cdev_del(&amp;(hello_dev-&gt;dev));</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>cleanup:</span></pre>
<pre><span><span> </span>kfree(hello_dev);</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>unregister:</span></pre>
<pre><span><span> </span>unregister_chrdev_region(MKDEV(hello_major, hello_minor), 1);</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>fail:</span></pre>
<pre><span><span> </span>return err;</span></pre>
<pre><span>}</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>/*</span><span>模块卸载方法<span>*/</span></span></pre>
<pre><span>static void __exit hello_exit(void) {</span></pre>
<pre><span><span> </span>dev_t devno = MKDEV(hello_major, hello_minor);</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>printk(KERN_ALERT"Destroy hello device.\n");<span></span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>/*</span><span>删除<span>/proc/hello</span>文件<span>*/</span></span></pre>
<pre><span><span> </span>hello_remove_proc();<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>/*</span><span>销毁设备类别和设备<span>*/</span></span></pre>
<pre><span><span> </span>if(hello_class) {</span></pre>
<pre><span><span> </span>device_destroy(hello_class, MKDEV(hello_major, hello_minor));</span></pre>
<pre><span><span> </span>class_destroy(hello_class);</span></pre>
<pre><span><span> </span>}<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>/*</span><span>删除字符设备和释放设备内存<span>*/</span></span></pre>
<pre><span><span> </span>if(hello_dev) {</span></pre>
<pre><span><span> </span>cdev_del(&amp;(hello_dev-&gt;dev));</span></pre>
<pre><span><span> </span>kfree(hello_dev);</span></pre>
<pre><span><span> </span>}<span> </span></span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span><span> </span>/*</span><span>释放设备号<span>*/</span></span></pre>
<pre><span><span> </span>unregister_chrdev_region(devno, 1);</span></pre>
<pre><span>}</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>MODULE_LICENSE("GPL");</span></pre>
<pre><span>MODULE_DESCRIPTION("First Android Driver");</span></pre>
<pre><span>&nbsp;</span></pre>
<pre><span>module_init(hello_init);</span></pre>
<pre><span>module_exit(hello_exit);</span></pre>
					<p>
						<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp;&nbsp; </span></span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">五</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">.</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">在</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">hello</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">目录中新增</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">Kconfig</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">和</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">Makefile</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">两个文件，其中</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">Kconfig</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">是在编译前执行配置命令</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">make menuconfig</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">时用到的，而</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">Makefile</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">是执行编译命令</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">make</span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">是用到的：</span> 
					</p>
					<p>
						<strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp;
&nbsp; &nbsp; Kconfig</span></strong><strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件的内容</span></strong> 
					</p>
					<div>
						<p class="MsoNormal">
							<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; config HELLO</span> 
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
tristate "First Android Driver"</span> 
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
default n</span> 
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
help</span> 
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
This is the first android driver.</span> 
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp;
&nbsp; &nbsp;Makefile</span></strong><strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件的内容</span></strong> 
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp;obj-$(CONFIG_HELLO)
+= hello.o</span> 
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">在</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Kconfig</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件中，</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">tristate</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">表示编译选项</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">HELLO</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">支持在编译内核时，</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">模块支持以模块、内建和不编译三种编译方法，默认是不编译，因此，在编译内核前，还需要执行</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">make menuconfig</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">命令来配置编译选项，使得</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">可以以模块或者内建的方法进行编译。</span> 
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">在</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Makefile</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件中，根据选项</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">HELLO</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">的值，执行不同的编译方法。</span> 
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">六</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">. </span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">修改</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">arch/arm/Kconfig</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">和</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">drivers/kconfig</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">两个文件(修改一个就可以了,不然会报错.)，在</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">menu "Device Drivers"</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">和</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">endmenu</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">之间添加一行：</span> 
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp;</span><strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">source
"drivers/hello/Kconfig"</span></strong> 
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp;
&nbsp; &nbsp;</span></strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">这样，执行</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">make menuconfig</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">时，就可以配置</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">模块的编译选项了。</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">.&nbsp;</span> 
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">七</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">.&nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">修改</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">drivers/Makefile</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件，添加一行：</span>
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">obj-$(CONFIG_HELLO) += hello/</span></strong></span> 
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp;
&nbsp; &nbsp;</span></strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">八</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">. </span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">配置编译选项：</span>
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">USER-NAME@MACHINE-NAME:~/Android/kernel/common$&nbsp;make
menuconfig</span></strong></span> 
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">找到</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">"Device
Drivers" =&gt; "First Android Drivers"</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">选项，设置为</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">y</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">。</span>
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">注意，如果内核不支持动态加载模块，这里不能选择</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">m</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">，虽然在</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Kconfig</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件中配置了</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">HELLO</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">选项为</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">tristate</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">。要支持动态加载模块选项，必须要在配置菜单中选择</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Enable
loadable module support</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">选项；在支持动态卸载模块选项，必须要在</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Enable
loadable module support</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">菜单项中，选择</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Module unloading</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">选项。</span>
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">九</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">. </span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">编译：</span>
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">USER-NAME@MACHINE-NAME:~/Android/kernel/common$&nbsp;make</span></strong></span> 
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp;
&nbsp; &nbsp;</span></strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">编译成功后，就可以在</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">目录下看到</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello.o</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件了，这时候编译出来的</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">zImage</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">已经包含了</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">驱动。</span>
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">十</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">. </span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">参照</span><span><a href="http://blog.csdn.net/luoshengyang/article/details/6564592"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">在Ubuntu</span></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">上下载、编译和安装Android</span></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">最新内核源代码（Linux
Kernel</span></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">）</span></span></a></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">一文所示，运行新编译的内核文件，验证</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">驱动程序是否已经正常安装：</span>
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">USER-NAME@MACHINE-NAME:~/Android$&nbsp;emulator
-kernel ./kernel/common/arch/arm/boot/zImage &amp;</span></strong></span> 
						</p>
					</div>
					<div>
						<p class="MsoNormal">
							<strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp;
&nbsp; &nbsp;USER-NAME@MACHINE-NAME:~/Android$ adb shell</span></strong> 
						</p>
					</div>
					<div>
						<div>
							<p class="MsoNormal">
								<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">进入到</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">dev</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">目录，可以看到</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">设备文件：</span>
							</p>
						</div>
						<div>
							<p class="MsoNormal">
								<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;root@android:/ # cd dev</span> 
							</p>
						</div>
						<div>
							<p class="MsoNormal">
								<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;root@android:/dev # ls</span> 
							</p>
						</div>
						<div>
							<div>
								<div>
									<p class="MsoNormal">
										<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">进入到</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">proc</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">目录，可以看到</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件：</span>
									</p>
								</div>
								<div>
									<p class="MsoNormal">
										<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;root@android:/ # cd proc</span> 
									</p>
								</div>
								<div>
									<p class="MsoNormal">
										<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;root@android:/proc # ls</span> 
									</p>
								</div>
								<div>
									<p class="MsoNormal">
										<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">访问</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件的值：</span>
									</p>
								</div>
								<div>
									<p class="MsoNormal">
										<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;root@android:/proc # cat hello</span> 
									</p>
								</div>
								<div>
									<p class="MsoNormal">
										<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;0</span> 
									</p>
								</div>
								<div>
									<div>
										<div>
											<div>
												<div>
													<div>
														<p class="MsoNormal">
															<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;root@android:/proc # echo '5' &gt;
hello</span> 
														</p>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
								<div>
									<div>
										<div>
											<div>
												<div>
													<div>
														<div>
															<div>
																<div>
																	<div>
																		<p class="MsoNormal">
																			<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;root@android:/proc # cat hello</span> 
																		</p>
																	</div>
																</div>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div>
							<p class="MsoNormal">
								<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;5</span> 
							</p>
						</div>
						<div>
							<p class="MsoNormal">
								<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">进入到</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">sys/class</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">目录，可以看到</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">目录：</span>
							</p>
						</div>
						<div>
							<div>
								<div>
									<div>
										<p class="MsoNormal">
											<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;root@android:/ # cd sys/class</span> 
										</p>
									</div>
									<div>
										<p class="MsoNormal">
											<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;root@android:/sys/class # ls</span> 
										</p>
									</div>
									<div>
										<p class="MsoNormal">
											<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">进入到</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">目录，可以看到</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">目录：</span>
										</p>
									</div>
									<div>
										<p class="MsoNormal">
											<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;root@android:/sys/class # cd hello</span> 
										</p>
									</div>
									<div>
										<p class="MsoNormal">
											<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;root@android:/sys/class/hello # ls</span> 
										</p>
									</div>
									<div>
										<div>
											<div>
												<div>
													<div>
														<div>
															<div>
																<div>
																	<p class="MsoNormal">
																		<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">进入到下一层</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">目录，可以看到</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">val</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件：</span>
																	</p>
																</div>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div>
						<div>
							<div>
								<div>
									<div>
										<p class="MsoNormal">
											<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;root@android:/sys/class/hello # cd
hello</span> 
										</p>
									</div>
									<div>
										<div>
											<div>
												<div>
													<div>
														<div>
															<div>
																<div>
																	<p class="MsoNormal">
																		<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;root@android:/sys/class/hello/hello
# ls</span> 
																	</p>
																</div>
																<div>
																	<p class="MsoNormal">
																		<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">访问属性文件</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">val</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">的值：</span>
																	</p>
																</div>
																<div>
																	<div>
																		<div>
																			<div>
																				<div>
																					<div>
																						<div>
																							<div>
																								<div>
																									<div>
																										<div>
																											<div>
																												<div>
																													<div>
																														<p class="MsoNormal">
																															<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;root@android:/sys/class/hello/hello
# cat val</span> 
																														</p>
																													</div>
																												</div>
																											</div>
																										</div>
																									</div>
																								</div>
																							</div>
																						</div>
																					</div>
																				</div>
																			</div>
																		</div>
																	</div>
																</div>
																<div>
																	<div>
																		<div>
																			<p class="MsoNormal">
																				<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;5</span> 
																			</p>
																		</div>
																		<div>
																			<div>
																				<div>
																					<div>
																						<div>
																							<div>
																								<div>
																									<div>
																										<div>
																											<div>
																												<div>
																													<div>
																														<div>
																															<div>
																																<div>
																																	<div>
																																		<div>
																																			<div>
																																				<div>
																																					<div>
																																						<div>
																																							<div>
																																								<div>
																																									<div>
																																										<div>
																																											<div>
																																												<div>
																																													<div>
																																														<div>
																																															<div>
																																																<div>
																																																	<div>
																																																		<div>
																																																			<div>
																																																				<div>
																																																					<div>
																																																						<div>
																																																							<p class="MsoNormal">
																																																								<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;root@android:/sys/class/hello/hello
# echo '0' &nbsp;&gt; val</span> 
																																																							</p>
																																																						</div>
																																																					</div>
																																																				</div>
																																																			</div>
																																																		</div>
																																																	</div>
																																																</div>
																																															</div>
																																														</div>
																																													</div>
																																												</div>
																																											</div>
																																										</div>
																																									</div>
																																								</div>
																																							</div>
																																						</div>
																																					</div>
																																				</div>
																																			</div>
																																		</div>
																																	</div>
																																</div>
																															</div>
																														</div>
																													</div>
																												</div>
																											</div>
																										</div>
																									</div>
																								</div>
																							</div>
																						</div>
																					</div>
																				</div>
																			</div>
																		</div>
																		<div>
																			<div>
																				<div>
																					<div>
																						<div>
																							<div>
																								<div>
																									<div>
																										<div>
																											<div>
																												<div>
																													<div>
																														<div>
																															<div>
																																<div>
																																	<div>
																																		<div>
																																			<div>
																																				<div>
																																					<div>
																																						<div>
																																							<div>
																																								<div>
																																									<div>
																																										<div>
																																											<div>
																																												<div>
																																													<div>
																																														<div>
																																															<div>
																																																<div>
																																																	<div>
																																																		<div>
																																																			<div>
																																																				<div>
																																																					<div>
																																																						<div>
																																																							<div>
																																																								<div>
																																																									<div>
																																																										<div>
																																																											<div>
																																																												<div>
																																																													<div>
																																																														<div>
																																																															<div>
																																																																<div>
																																																																	<div>
																																																																		<div>
																																																																			<div>
																																																																				<div>
																																																																					<div>
																																																																						<div>
																																																																							<div>
																																																																								<div>
																																																																									<div>
																																																																										<div>
																																																																											<div>
																																																																												<div>
																																																																													<div>
																																																																														<div>
																																																																															<p class="MsoNormal">
																																																																																<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;root@android:/sys/class/hello/hello
# cat val</span> 
																																																																															</p>
																																																																														</div>
																																																																													</div>
																																																																												</div>
																																																																											</div>
																																																																										</div>
																																																																									</div>
																																																																								</div>
																																																																							</div>
																																																																						</div>
																																																																					</div>
																																																																				</div>
																																																																			</div>
																																																																		</div>
																																																																	</div>
																																																																</div>
																																																															</div>
																																																														</div>
																																																													</div>
																																																												</div>
																																																											</div>
																																																										</div>
																																																									</div>
																																																								</div>
																																																							</div>
																																																						</div>
																																																					</div>
																																																				</div>
																																																			</div>
																																																		</div>
																																																	</div>
																																																</div>
																																															</div>
																																														</div>
																																													</div>
																																												</div>
																																											</div>
																																										</div>
																																									</div>
																																								</div>
																																							</div>
																																						</div>
																																					</div>
																																				</div>
																																			</div>
																																		</div>
																																	</div>
																																</div>
																															</div>
																														</div>
																														<div>
																															<div>
																																<div>
																																	<div>
																																		<div>
																																			<div>
																																				<div>
																																					<div>
																																						<div>
																																							<div>
																																								<div>
																																									<div>
																																										<div>
																																											<p class="MsoNormal">
																																												<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;0</span> 
																																											</p>
																																										</div>
																																										<div>
																																											<p class="MsoNormal">
																																												<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">至此，</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">内核驱动程序就完成了，并且验证一切正常。这里采用的是系统提供的方法和驱动程序进行交互，也就是通过</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">proc</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件系统和</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">devfs</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件系统的方法，下面，将通过自己编译的</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">C</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">语言程序来访问</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">/dev/hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件来和</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">驱动程序交互，敬请期待。</span>
																																											</p>
																																										</div>
																																									</div>
																																								</div>
																																							</div>
																																						</div>
																																					</div>
																																				</div>
																																			</div>
																																		</div>
																																	</div>
																																</div>
																															</div>
																														</div>
																													</div>
																												</div>
																											</div>
																										</div>
																									</div>
																								</div>
																							</div>
																						</div>
																					</div>
																				</div>
																			</div>
																		</div>
																	</div>
																</div>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<p class="MsoNormal" style="text-indent:2em;">
	<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;</span>
</p>
<p class="MsoNormal" style="text-indent:2em;">
	<span></span>
</p>
<div id="container" style="font-family:微软雅黑;font-size:medium;">
	<div id="body">
		<div id="main">
			<div>
				<div id="article_details">
					<div id="article_content">
						<div>
							<div>
								<div>
									<div>
										<div>
											<div>
												<div>
													<div>
														<div>
															<div>
																<div>
																	<div>
																		<div>
																			<div>
																				<div>
																					<div>
																						<div>
																							<div>
																								<div>
																									<div>
																										<div>
																											<div>
																												<div>
																													<div>
																														<div>
																															<div>
																																<div>
																																	<div>
																																		<div>
																																			<div>
																																				<div>
																																					<div>
																																						<div>
																																							<div>
																																								<div>
																																									<div>
																																										<div>
																																											<div>
																																												<p class="MsoNormal" style="font-size:12pt;font-family:宋体;">
																																													<span style="font-size:13.5pt;font-family:微软雅黑;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">驱动测试</span><span></span></span>
																																												</p>
																																											</div>
																																										</div>
																																									</div>
																																								</div>
																																							</div>
																																						</div>
																																					</div>
																																				</div>
																																			</div>
																																		</div>
																																	</div>
																																</div>
																															</div>
																														</div>
																													</div>
																												</div>
																											</div>
																										</div>
																									</div>
																								</div>
																							</div>
																						</div>
																					</div>
																				</div>
																			</div>
																		</div>
																	</div>
																</div>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<p style="margin-left:0cm;font-size:medium;font-family:宋体;text-indent:2em;">
	<span style="font-size:13.5pt;font-family:微软雅黑;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">上面，介绍了如何在</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Ubuntu</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">上为</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">系统编写</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Linux</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">内核驱动程序。在这个名为</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">的</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Linux</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">内核驱动程序中，创建三个不同的文件节点来供用户空间访问，分别是传统的设备文件</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">/dev/hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">、</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">proc</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">系统文件</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">/proc/hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">和</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">devfs</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">系统属性文件</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">/sys/class/hello/hello/val</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">。进一步，还通过</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">cat</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">命令来直接访问</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">/proc/hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">和</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">/sys/class/hello/hello/val</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件来，以验证驱动程序的正确性。在这一篇文章里，将通过自己编写的</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">C</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">可执行程序来访问设备文件</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">/dev/hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">。可能读者会觉得奇怪，怎么能在</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">系统中用</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">C</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">语言来编写应用程序呢？</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">系统上的应用程序不都是</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Java</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">应用程序吗？其实是可以的，读者不妨用</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">adb shell</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">命令连上</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">模拟器，在</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">/system/bin</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">目录下可以看到很多</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">C</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">可执行程序，如</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">cat</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">命令。今天，就来学习一下怎么在</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">系统中添加用</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">C</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">语言编写的可执行程序吧。</span><span></span></span>
</p>
<p style="margin-left:0cm;font-size:medium;font-family:宋体;text-indent:2em;">
	<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;</span><span style="font-size:13.5pt;font-family:微软雅黑;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">一</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">.&nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">参照</span><span><a href="http://blog.csdn.net/luoshengyang/article/details/6568411"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">在Ubuntu</span></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">上为Android</span></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">系统编写Linux</span></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">内核驱动程序</span></span></a></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">一文，准备好</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Linux</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">驱动程序。使用</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">模拟器加载包含这个</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Linux</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">驱动程序的内核文件，并且使用</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">adb shell</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">命令连接上模拟，验证在</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">/dev</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">目录中存在设备文件</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">。</span><span></span></span>
</p>
<p style="margin-left:0cm;font-size:medium;font-family:宋体;text-indent:2em;">
	<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;</span><span style="font-size:13.5pt;font-family:微软雅黑;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">二</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">.&nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">进入到</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">源代码工程的</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">external</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">目录，创建</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">目录</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">:</span></span>
</p>
<p style="margin-left:0cm;font-size:medium;font-family:宋体;text-indent:2em;">
	<span style="font-size:13.5pt;font-family:微软雅黑;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp;</span><strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">USER-NAME@MACHINE-NAME:~/Android$ cd external</span></strong></span>
</p>
<p style="margin-left:0cm;font-size:medium;font-family:宋体;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;USER-NAME@MACHINE-NAME:~/Android/external$ mkdir hello</span></strong><span style="font-size:13.5pt;font-family:微软雅黑;"></span>
</p>
<p style="margin-left:0cm;font-size:medium;font-family:宋体;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;</span></strong><strong><span style="font-size:13.5pt;font-family:微软雅黑;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">三</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">.</span></span></strong><span class="apple-converted-space" style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><b><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;</span></b></span><span style="font-size:13.5pt;font-family:微软雅黑;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">在</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">目录中新建</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello.c</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件：</span><span></span></span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span class="preprocessor" style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">#include&nbsp;&lt;stdio.h&gt;</span></span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;</span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span class="preprocessor" style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">#include&nbsp;&lt;stdlib.h&gt;</span></span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;</span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span class="preprocessor" style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">#include&nbsp;&lt;fcntl.h&gt;</span></span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;</span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span class="preprocessor" style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">#define&nbsp;DEVICE_NAME&nbsp;"/dev/hello"</span></span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;</span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span class="datatypes" style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">int</span></span><span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;main(</span><span class="datatypes" style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">int</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;argc,&nbsp;</span><span class="datatypes" style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">char</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">**&nbsp;argv)&nbsp;&nbsp;</span></span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">{&nbsp;&nbsp;</span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="datatypes" style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">int</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;fd&nbsp;=&nbsp;-1;&nbsp;&nbsp;</span></span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="datatypes" style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">int</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;val&nbsp;=&nbsp;0;&nbsp;&nbsp;</span></span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;fd&nbsp;=&nbsp;open(DEVICE_NAME,&nbsp;O_RDWR);&nbsp;&nbsp;</span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword" style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><b><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;color:blue;">if</span></b></span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">(fd&nbsp;==&nbsp;-1)&nbsp;{&nbsp;&nbsp;</span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span class="string" style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;color:#8C8C8C;">"Failed&nbsp;to&nbsp;open&nbsp;device&nbsp;%s.\n"</span></span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">,&nbsp;DEVICE_NAME);&nbsp;&nbsp;</span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword" style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">return</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;-1;&nbsp;&nbsp;</span></span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span class="string" style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;color:#8C8C8C;">"Read&nbsp;original&nbsp;value:\n"</span></span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">);&nbsp;&nbsp;</span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp;&nbsp;&nbsp;read(fd,&nbsp;&amp;val,&nbsp;</span><span class="keyword" style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">sizeof</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">(val));&nbsp;&nbsp;</span></span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span class="string" style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;color:#8C8C8C;">"%d.\n\n"</span></span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">,&nbsp;val);&nbsp;&nbsp;</span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;val&nbsp;=&nbsp;5;&nbsp;&nbsp;</span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span class="string" style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;color:#8C8C8C;">"Write&nbsp;value&nbsp;%d&nbsp;to&nbsp;%s.\n\n"</span></span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">,&nbsp;val,&nbsp;DEVICE_NAME);&nbsp;&nbsp;</span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write(fd,&nbsp;&amp;val,&nbsp;</span><span class="keyword" style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">sizeof</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">(val));&nbsp;&nbsp;</span></span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span class="string" style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;color:#8C8C8C;">"Read&nbsp;the&nbsp;value&nbsp;again:\n"</span></span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">);&nbsp;&nbsp;</span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;read(fd,&nbsp;&amp;val,&nbsp;</span><span class="keyword" style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">sizeof</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">(val));&nbsp;&nbsp;</span></span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span class="string" style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;color:#8C8C8C;">"%d.\n\n"</span></span><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">,&nbsp;val);&nbsp;&nbsp;</span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;close(fd);&nbsp;&nbsp;</span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword" style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">return</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;0;&nbsp;&nbsp;</span></span>
</p>
<p class="MsoNormal" style="font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">}&nbsp;&nbsp;</span>
</p>
<p style="margin-left:0cm;font-size:medium;font-family:宋体;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;</span></strong><span style="font-size:13.5pt;font-family:微软雅黑;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">这个程序的作用中，打开</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">/dev/hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件，然后先读出</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">/dev/hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件中的值，接着写入值</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">5</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">到</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">/dev/hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">中去，最后再次读出</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">/dev/hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件中的值，看看是否是刚才写入的值</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">5</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">。从</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">/dev/hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件读写的值实际上就是虚拟的硬件的寄存器</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">val</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">的值。</span><span></span></span>
</p>
<p style="margin-left:0cm;font-size:medium;font-family:宋体;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;</span></strong><span style="font-size:13.5pt;font-family:微软雅黑;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">四</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">.&nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">在</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">目录中新建</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android.mk</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件：</span><span></span></span>
</p>
<p style="margin-left:30pt;font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp;&nbsp;</span></strong><strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;LOCAL_PATH := $(call my-dir)</span></strong><span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"></span>
</p>
<p style="margin-left:30pt;font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;include $(CLEAR_VARS)</span></strong><span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"></span>
</p>
<p style="margin-left:30pt;font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;LOCAL_MODULE_TAGS := optional</span></strong><span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"></span>
</p>
<p style="margin-left:30pt;font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;LOCAL_MODULE := hello</span></strong><span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"></span>
</p>
<p style="margin-left:30pt;font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;LOCAL_SRC_FILES := $(call all-subdir-c-files)</span></strong><span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"></span>
</p>
<p style="margin-left:30pt;font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;include $(BUILD_EXECUTABLE)</span></strong><span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"></span>
</p>
<p style="margin-left:0cm;font-size:medium;font-family:宋体;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;</span></strong><span style="font-size:13.5pt;font-family:微软雅黑;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">注意，</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">BUILD_EXECUTABLE</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">表示要编译的是可执行程序。</span><strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;</span></strong><span></span></span>
</p>
<p style="margin-left:0cm;font-size:medium;font-family:宋体;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;</span></strong><span style="font-size:13.5pt;font-family:微软雅黑;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">五</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">.&nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">参照</span><span><a href="http://blog.csdn.net/luoshengyang/article/details/6566662"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">如何单独编译Android</span></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">源代码中的模块</span></span></a></span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">一文，使用</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">mmm</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">命令进行编译：</span><span></span></span>
</p>
<p style="margin-left:0cm;font-size:medium;font-family:宋体;text-indent:2em;">
	<span style="font-size:13.5pt;font-family:微软雅黑;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp;</span><strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">USER-NAME@MACHINE-NAME:~/Android$ mmm ./external/hello</span></strong></span>
</p>
<p style="margin-left:0cm;font-size:medium;font-family:宋体;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;</span></strong><span style="font-size:13.5pt;font-family:微软雅黑;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">编译成功后，就可以在</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">out/target/product/gerneric/system/bin</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">目录下，看到可执行文件</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">了。</span><span></span></span>
</p>
<p style="margin-left:0cm;font-size:medium;font-family:宋体;text-indent:2em;">
	<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;</span><span style="font-size:13.5pt;font-family:微软雅黑;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">六</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">.&nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">重新打包</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">系统文件</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">system.img</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">：</span><span></span></span>
</p>
<p style="margin-left:0cm;font-size:medium;font-family:宋体;text-indent:2em;">
	<span style="font-size:13.5pt;font-family:微软雅黑;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp; &nbsp; &nbsp;</span><strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">USER-NAME@MACHINE-NAME:~/Android$ make snod</span></strong></span>
</p>
<p style="margin-left:0cm;font-size:medium;font-family:宋体;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;</span></strong><span style="font-size:13.5pt;font-family:微软雅黑;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">这样，重新打包后的</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">system.img</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">文件就包含刚才编译好的</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">可执行文件了。</span><span></span></span>
</p>
<p style="margin-left:0cm;font-size:medium;font-family:宋体;text-indent:2em;">
	<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;</span><span style="font-size:13.5pt;font-family:微软雅黑;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">七</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">.&nbsp;</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">运行模拟器，使用</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">/system/bin/hello</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">可执行程序来访问</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Linux</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">内核驱动程序：</span><span></span></span>
</p>
<p style="margin-left:30pt;font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp;</span><span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">&nbsp;&nbsp;</span><strong><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">USER-NAME@MACHINE-NAME:~/Android$ emulator -kernel ./kernel/common/arch/arm/boot/zImage &amp;</span></strong></span>
</p>
<p style="margin-left:30pt;font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;USER-NAME@MACHINE-NAME:~/Android$ adb shell</span></strong><span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"></span>
</p>
<p style="margin-left:30pt;font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;root@android:/ # cd system/bin</span></strong><span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"></span>
</p>
<p style="margin-left:30pt;font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;root@android:/system/bin # ./hello</span></strong><span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"></span>
</p>
<p style="margin-left:30pt;font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;Read the original value:</span></strong><span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"></span>
</p>
<p style="margin-left:30pt;font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;0.</span></strong><span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"></span>
</p>
<p style="margin-left:30pt;font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;Write value 5 to /dev/hello.</span></strong><span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"></span>
</p>
<p style="margin-left:30pt;font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;Read the value again:</span></strong><span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"></span>
</p>
<p style="margin-left:30pt;font-size:medium;font-family:宋体;background-color:#D9D9D9;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;5.</span></strong><span style="font-size:10pt;font-family:&#39;Lucida Console&#39;;"></span>
</p>
<p style="margin-left:0cm;font-size:medium;font-family:宋体;text-indent:2em;">
	<strong><span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;</span></strong><span style="font-size:13.5pt;font-family:微软雅黑;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">看到这个结果，就说编写的</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">C</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">可执行程序可以访问编写的</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Linux</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">内核驱动程序了。</span><span></span></span>
</p>
<p style="margin-left:0cm;font-size:medium;font-family:宋体;text-indent:2em;">
	<span style="font-size:18px;font-family:&#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; &nbsp;</span><span style="font-size:13.5pt;font-family:微软雅黑;"><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">介绍完了如何使用</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">C</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">语言编写的可执行程序来访问</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Linux</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">内核驱动程序，读者可能会问，能不能在</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">的</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Application Frameworks</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">提供</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Java</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">接口来访问</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Linux</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">内核驱动程序呢？可以的，接下来的几篇文章中，将介绍如何在</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Android</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">的</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Application Frameworks</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">中，增加</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Java</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">接口来访问</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">Linux</span><span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;">内核驱动程序，敬请期待。</span></span>
</p>
<p style="text-indent:2em;">
	<span style="font-family:&#39;Microsoft YaHei&#39;;font-size:18px;"></span>
</p>
<p style="text-indent:2em;">
	<br>
</p>
<p class="MsoNormal" style="text-indent:2em;">
	<span><br>
</span>
</p>
<p style="text-indent:2em;">
	<br>
</p></body></html>